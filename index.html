<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Instagram ‚Üí YouTube Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 800px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], select, textarea {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    textarea {
      width: 100%;
      max-width: 500px;
      min-height: 100px;
      font-family: inherit;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #login, #submit {
      background-color: #4CAF50;
      color: white;
    }
    #logout {
      background-color: #666;
      color: white;
    }
    #clearAuth {
      background-color: #dc3545;
      color: white;
    }
    .video-editor-section {
      background-color: #f0f8ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border: 2px solid #4CAF50;
    }
    .video-editor-section h4 {
      margin-top: 0;
      color: #2e7d32;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .helper-text {
      font-size: 12px;
      color: #666;
      margin-top: 3px;
    }
    .file-upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      background-color: #f9f9f9;
    }
    .file-upload-area:hover {
      border-color: #4CAF50;
      background-color: #f0f8ff;
    }
    .preview-image {
      max-width: 300px;
      margin-top: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .fetched-content {
      background-color: #f0f8ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border: 2px solid #2196F3;
    }
  </style>
</head>
<body>

<h2>Instagram ‚Üí YouTube Admin</h2>

<button id="login">Login with Google</button>
<button id="logout">Logout</button>
<button id="clearAuth">Clear Auth & Retry</button>

<div id="panel" style="display:none; margin-top: 20px;">

  <!-- Toggle buttons for different sections -->
  <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    <button id="toggleInstagram" style="background-color: #E1306C; color: white;">üì∏ Instagram Reels</button>
    <button id="toggleAIShorts" style="background-color: #4CAF50; color: white;">ü§ñ AI Story Shorts</button>
    <button id="toggleRedditBroll" style="background-color: #FF4500; color: white;">üì• Reddit B-roll</button>
    <button id="toggleRedditShorts" style="background-color: #FF8C00; color: white;">üìù Reddit Shorts</button>
  </div>

  <!-- SECTION 1: Instagram Reels (existing) -->
  <div id="instagramSection" style="display:none;">
    <h3>Add Instagram Link</h3>
    
    <div class="form-group">
      <label for="link">Instagram URL *</label>
      <input type="text" id="link" placeholder="https://www.instagram.com/reel/..." style="width:100%; max-width:500px;">
    </div>

    <div class="form-group">
      <label for="title">Custom Title (Optional)</label>
      <input type="text" id="title" placeholder="Leave empty to use caption" style="width:100%; max-width:500px;">
    </div>

    <div class="form-group">
      <label for="description">Custom Description (Optional)</label>
      <input type="text" id="description" placeholder="Leave empty to use caption" style="width:100%; max-width:500px;">
    </div>

    <!-- Video Editing Section -->
    <div class="video-editor-section">
      <h4>‚ú® Video Editing (AI-Powered)</h4>
      
      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="enable_editing" checked>
          <label for="enable_editing" style="margin-bottom: 0;">Enable AI hooks & subtitles</label>
        </div>
        <div class="helper-text">
          Adds AI-generated hook at the start + professional subtitles throughout the video
        </div>
      </div>

      <div class="form-group">
        <label for="subtitle_position">Subtitle Position</label>
        <select id="subtitle_position" style="width: 200px;">
          <option value="bottom" selected>Bottom (Default)</option>
          <option value="center">Center</option>
          <option value="top">Top</option>
        </select>
        <div class="helper-text">
          Choose where subtitles appear on the video
        </div>
      </div>
    </div>

    <button id="submit" style="margin-top: 20px;">Submit Job</button>

    <h3>Queue Status (Last 10 Jobs)</h3>
    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
      <button id="refreshQueue" style="background-color: #2196F3; color: white;">
        üîÑ Refresh Queue
      </button>
      <button id="cleanupOld" style="background-color: #ff9800; color: white;">
        üóëÔ∏è Cleanup Old Records (30+ days)
      </button>
      <span id="cleanupStatus" style="font-size: 12px; color: #666;"></span>
    </div>
    <div id="videos" style="margin-top:10px;"></div>
  </div>

  <!-- SECTION 2: AI Story Shorts -->
  <div id="aiShortsSection" style="display:none;">
    <h3>ü§ñ Generate AI Story Short</h3>
    
    <div class="form-group">
      <label for="aiTopic">Story Topic (Optional)</label>
      <input type="text" id="aiTopic" placeholder="e.g., family betrayal, workplace revenge, etc. (leave empty for random)" style="width:100%; max-width:500px;">
      <div class="helper-text">
        Leave empty to let AI choose a compelling story topic
      </div>
    </div>

    <button id="submitAIShort" style="background-color: #4CAF50; color: white; margin-top: 20px;">‚ú® Generate Short</button>

    <h3>AI Shorts Queue (Last 10 Jobs)</h3>
    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
      <button id="refreshAIQueue" style="background-color: #2196F3; color: white;">
        üîÑ Refresh Queue
      </button>
      <button id="cleanupAIQueue" style="background-color: #ff9800; color: white;">
        üóëÔ∏è Delete Records Older Than 10
      </button>
      <span id="aiStatus" style="font-size: 12px; color: #666;"></span>
    </div>
    <div id="aiVideos" style="margin-top:10px;"></div>
  </div>

  <!-- SECTION 3: Reddit B-roll Download (NEW) -->
  <div id="redditBrollSection" style="display:none;">
    <h3>üì• Download Reddit Video as B-roll</h3>
    
    <div class="form-group">
      <label for="redditBrollUrl">Reddit Post URL *</label>
      <input type="text" id="redditBrollUrl" placeholder="https://www.reddit.com/r/funny/comments/..." style="width:100%; max-width:500px;">
      <div class="helper-text">
        Paste a Reddit post URL that contains a video. The video will be downloaded and saved as B-roll.
      </div>
    </div>

    <button id="downloadRedditBroll" style="background-color: #FF4500; color: white; margin-top: 20px;">üì• Download as B-roll</button>
    
    <div id="brollDownloadStatus" style="margin-top: 15px; font-size: 14px;"></div>

    <h3>Available B-rolls</h3>
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button id="refreshBrolls" style="background-color: #2196F3; color: white;">
        üîÑ Refresh List
      </button>
    </div>
    <div id="brollList" style="margin-top:10px;"></div>
  </div>

  <!-- SECTION 4: Reddit Shorts Creation (NEW) -->
  <div id="redditShortsSection" style="display:none;">
    <h3>üìù Create Reddit Short (Manual Curation)</h3>
    
    <div class="form-group">
      <label for="redditPostUrl">Reddit Post URL *</label>
      <input type="text" id="redditPostUrl" placeholder="https://www.reddit.com/r/AskReddit/comments/..." style="width:100%; max-width:500px;">
      <div class="helper-text">
        Paste a Reddit post URL. We'll fetch the title and content for you to edit.
      </div>
    </div>

    <button id="fetchRedditPost" style="background-color: #2196F3; color: white;">üîç Fetch Post</button>

    <!-- Fetched content (hidden until fetched) -->
    <div id="fetchedContent" class="fetched-content" style="display:none;">
      <h4 style="margin-top: 0;">‚úÖ Post Fetched - Edit Below</h4>
      
      <div class="form-group">
        <label for="redditTitle">Title (will be spoken by TTS)</label>
        <input type="text" id="redditTitle" style="width:100%; max-width:500px;">
      </div>

      <div class="form-group">
        <label for="redditDescription">Description (will be spoken by TTS)</label>
        <textarea id="redditDescription"></textarea>
      </div>

      <div class="form-group">
        <label for="redditCardFile">Upload Custom Reddit Card PNG</label>
        <div class="file-upload-area" id="cardUploadArea">
          <input type="file" id="redditCardFile" accept="image/png,image/jpg,image/jpeg" style="display:none;">
          <p>üì§ Click to upload custom Reddit card image</p>
          <small style="color: #666;">Will be overlaid on B-roll (no card generation)</small>
        </div>
        <img id="cardPreview" class="preview-image" style="display:none;">
      </div>

      <div class="form-group">
        <label for="brollSelect">Select B-roll *</label>
        <select id="brollSelect" style="width:100%; max-width:500px;">
          <option value="">Select a B-roll video...</option>
        </select>
        <div class="helper-text">
          Choose from downloaded Reddit B-roll videos
        </div>
      </div>

      <button id="submitRedditShort" style="background-color: #FF8C00; color: white; margin-top: 20px;">üöÄ Create Video</button>
    </div>

    <h3>Reddit Shorts Queue (Last 10 Jobs)</h3>
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button id="refreshRedditQueue" style="background-color: #2196F3; color: white;">
        üîÑ Refresh Queue
      </button>
      <button id="cleanupRedditQueue" style="background-color: #ff9800; color: white;">
        üóëÔ∏è Delete Records Older Than 10
      </button>
      <span id="redditStatus" style="font-size: 12px; color: #666;"></span>
    </div>
    <div id="redditVideos" style="margin-top:10px;"></div>
  </div>

</div>

<script>
// Supabase client
const supabaseClient = window.supabase.createClient(
  "https://colyuvayzgcdifnuivnz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvbHl1dmF5emdjZGlmbnVpdm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5ODk1MDMsImV4cCI6MjA4NjU2NTUwM30.tDiCCUp5uBH7j05QP-Yy_0rwF7mqxMVPaoQViYEl2MM"
);

const ADMIN_EMAIL = "crazychannelprofessional@gmail.com";

// State for uploaded card file
let uploadedCardFile = null;

// ----------------------
// Detect if mobile device
// ----------------------
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// ----------------------
// Handle OAuth session on page load
// ----------------------
async function initAuth() {
  try {
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    
    if (error) {
      console.log("Session error:", error);
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname);
      }
      return;
    }
    
    if (window.location.hash) {
      history.replaceState(null, '', window.location.pathname);
    }
    
    checkUser();
    
  } catch (error) {
    console.log("Init auth error:", error);
  }
}

// ----------------------
// Show or hide admin panel
// ----------------------
async function checkUser() {
  const { data: { user } } = await supabaseClient.auth.getUser();

  if (user && user.email === ADMIN_EMAIL) {
    document.getElementById("panel").style.display = "block";
    loadVideos();
  } else {
    document.getElementById("panel").style.display = "none";
    console.log("Unauthorized or not logged in");
  }
}

// ----------------------
// Login button
// ----------------------
document.getElementById("login").onclick = async () => {
  const isMobile = isMobileDevice();
  
  const { data, error } = await supabaseClient.auth.signInWithOAuth({
    provider: 'google',
    options: { 
      redirectTo: 'https://dadopolumentol.github.io/instagram-youtube-admin/',
      ...(isMobile ? {} : { flowType: 'popup' })
    }
  });

  if (error) {
    console.log("Login error:", error);
    alert("Login failed - check console");
  }
};

// ----------------------
// Logout button
// ----------------------
document.getElementById("logout").onclick = async () => {
  await supabaseClient.auth.signOut();
  document.getElementById("panel").style.display = "none";
  
  if (window.location.hash) {
    history.replaceState(null, '', window.location.pathname);
  }
  
  location.reload();
};

// ----------------------
// Clear Auth button
// ----------------------
document.getElementById("clearAuth").onclick = () => {
  localStorage.clear();
  sessionStorage.clear();
  history.replaceState(null, '', window.location.pathname + window.location.search);
  alert("Auth data cleared. Click Login to try again.");
  location.reload();
};

// ----------------------
// Submit Instagram link
// ----------------------
document.getElementById("submit").onclick = async () => {
  const link = document.getElementById("link").value.trim();
  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const enable_editing = document.getElementById("enable_editing").checked;
  const subtitle_position = document.getElementById("subtitle_position").value;

  if (!link) { 
    alert("Instagram link required"); 
    return; 
  }

  try {
    await supabaseClient.from("queue").insert([{
      link: link,
      title: title || null,
      description: description || null,
      status: "pending",
      enable_editing: enable_editing,
      subtitle_position: subtitle_position
    }]);

    alert("Job submitted successfully!");
    
    document.getElementById("link").value = "";
    document.getElementById("title").value = "";
    document.getElementById("description").value = "";
    document.getElementById("enable_editing").checked = true;
    document.getElementById("subtitle_position").value = "bottom";
    
    loadVideos();
  } catch (err) {
    console.log("Insert error:", err);
    alert("Failed to insert link. Check console.");
  }
};

// ----------------------
// Section toggling
// ----------------------
document.getElementById("toggleInstagram").onclick = () => {
  hideAllSections();
  document.getElementById("instagramSection").style.display = "block";
};

document.getElementById("toggleAIShorts").onclick = () => {
  hideAllSections();
  document.getElementById("aiShortsSection").style.display = "block";
  loadAIVideos();
};

document.getElementById("toggleRedditBroll").onclick = () => {
  hideAllSections();
  document.getElementById("redditBrollSection").style.display = "block";
  loadBrolls();
};

document.getElementById("toggleRedditShorts").onclick = () => {
  hideAllSections();
  document.getElementById("redditShortsSection").style.display = "block";
  loadRedditQueue();
  loadBrollsForSelect();
};

function hideAllSections() {
  document.getElementById("instagramSection").style.display = "none";
  document.getElementById("aiShortsSection").style.display = "none";
  document.getElementById("redditBrollSection").style.display = "none";
  document.getElementById("redditShortsSection").style.display = "none";
}

// Default: show AI Shorts section
document.getElementById("aiShortsSection").style.display = "block";

// ----------------------
// Submit AI Short
// ----------------------
document.getElementById("submitAIShort").onclick = async () => {
  const topic = document.getElementById("aiTopic").value.trim();
  
  try {
    await supabaseClient.from("ai_shorts_queue").insert([{
      topic: topic || null,
      status: "pending",
      source: "ai_generated"
    }]);

    alert("AI Short job submitted!");
    document.getElementById("aiTopic").value = "";
    loadAIVideos();
  } catch (err) {
    console.log("Insert error:", err);
    alert("Failed to submit job. Check console.");
  }
};

// ----------------------
// Download Reddit B-roll
// ----------------------
document.getElementById("downloadRedditBroll").onclick = async () => {
  const url = document.getElementById("redditBrollUrl").value.trim();
  const statusEl = document.getElementById("brollDownloadStatus");
  
  if (!url) {
    alert("Reddit URL required");
    return;
  }
  
  statusEl.innerHTML = '<span style="color: blue;">‚è≥ Downloading video from Reddit...</span>';
  
  try {
    // Call backend API to download Reddit video
    const response = await fetch('http://localhost:5000/api/download-reddit-broll', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      statusEl.innerHTML = `<span style="color: green;">‚úÖ Downloaded: ${result.filename} (${result.duration}s)</span>`;
      document.getElementById("redditBrollUrl").value = "";
      loadBrolls();
    } else {
      statusEl.innerHTML = `<span style="color: red;">‚ùå Error: ${result.error}</span>`;
    }
  } catch (error) {
    statusEl.innerHTML = `<span style="color: red;">‚ùå Failed to download: ${error.message}</span>`;
  }
};

// ----------------------
// Fetch Reddit Post (client-side using Reddit's JSON API)
// ----------------------
document.getElementById("fetchRedditPost").onclick = async () => {
  const url = document.getElementById("redditPostUrl").value.trim();
  
  if (!url) {
    alert("Reddit URL required");
    return;
  }
  
  try {
    // Reddit's native JSON API - just add .json to the URL
    const jsonUrl = url.replace(/\/$/, '') + '.json';
    
    const response = await fetch(jsonUrl);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // Extract post data from Reddit's JSON structure
    // data is an array: [0] = post, [1] = comments
    const post = data[0].data.children[0].data;
    
    // Populate fields
    document.getElementById("redditTitle").value = post.title || '';
    document.getElementById("redditDescription").value = post.selftext || '';
    
    // Show fetched content section
    document.getElementById("fetchedContent").style.display = "block";
    
    alert("‚úÖ Post fetched successfully!");
    
  } catch (error) {
    console.error("Fetch error:", error);
    alert(`Failed to fetch post: ${error.message}\n\nMake sure the URL is a direct link to a Reddit post.`);
  }
};

// ----------------------
// Card file upload
// ----------------------
document.getElementById("cardUploadArea").onclick = () => {
  document.getElementById("redditCardFile").click();
};

document.getElementById("redditCardFile").onchange = (e) => {
  const file = e.target.files[0];
  if (file) {
    uploadedCardFile = file;
    
    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
      const preview = document.getElementById("cardPreview");
      preview.src = e.target.result;
      preview.style.display = "block";
    };
    reader.readAsDataURL(file);
  }
};

// ----------------------
// Submit Reddit Short
// ----------------------
document.getElementById("submitRedditShort").onclick = async () => {
  const title = document.getElementById("redditTitle").value.trim();
  const description = document.getElementById("redditDescription").value.trim();
  const brollFilename = document.getElementById("brollSelect").value;
  const redditUrl = document.getElementById("redditPostUrl").value.trim();
  
  if (!title || !brollFilename) {
    alert("Title and B-roll are required");
    return;
  }
  
  try {
    // If card file is uploaded, we need to upload it to Supabase Storage first
    let customCardUrl = null;
    
    if (uploadedCardFile) {
      const filename = `reddit_card_${Date.now()}.png`;
      const { data, error } = await supabaseClient.storage
        .from('reddit-cards')
        .upload(filename, uploadedCardFile);
      
      if (error) {
        console.log("Card upload error:", error);
        alert("Failed to upload card. Continuing without it...");
      } else {
        const { data: { publicUrl } } = supabaseClient.storage
          .from('reddit-cards')
          .getPublicUrl(filename);
        customCardUrl = publicUrl;
      }
    }
    
    // Insert job
    await supabaseClient.from("ai_shorts_queue").insert([{
      title: title,
      script: description,
      reddit_url: redditUrl,
      broll_filename: brollFilename,
      custom_card_url: customCardUrl,
      source: "reddit_manual",
      status: "pending"
    }]);
    
    alert("Reddit Short job submitted!");
    
    // Reset form
    document.getElementById("redditTitle").value = "";
    document.getElementById("redditDescription").value = "";
    document.getElementById("redditPostUrl").value = "";
    document.getElementById("redditCardFile").value = "";
    document.getElementById("cardPreview").style.display = "none";
    document.getElementById("fetchedContent").style.display = "none";
    uploadedCardFile = null;
    
    loadRedditQueue();
  } catch (err) {
    console.log("Insert error:", err);
    alert("Failed to submit job. Check console.");
  }
};

// ----------------------
// Load functions
// ----------------------
document.getElementById("refreshQueue").onclick = () => loadVideos();
document.getElementById("refreshAIQueue").onclick = () => loadAIVideos();
document.getElementById("refreshBrolls").onclick = () => loadBrolls();
document.getElementById("refreshRedditQueue").onclick = () => loadRedditQueue();

// Load Instagram queue (existing)
async function loadVideos() {
  try {
    const { data } = await supabaseClient
      .from("queue")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(10);

    const container = document.getElementById("videos");
    container.innerHTML = "";

    if (!data || data.length === 0) {
      container.innerHTML = "<p>No jobs in queue yet.</p>";
      return;
    }

    data.forEach(video => {
      const scheduledTime = video.scheduled_publish_at 
        ? new Date(video.scheduled_publish_at).toLocaleString() 
        : "Not scheduled";
      
      const statusColor = {
        'pending': 'orange',
        'processing': 'blue',
        'done': 'green',
        'failed': 'red'
      }[video.status] || 'gray';

      const editingStatus = video.enable_editing 
        ? `‚úÖ Editing enabled (${video.subtitle_position || 'bottom'})` 
        : '‚è≠Ô∏è Editing disabled';

      container.innerHTML += `
        <div style="margin-bottom:15px; padding:15px; border-left: 4px solid ${statusColor}; background-color: #f9f9f9;">
          <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${video.status}</span><br>
          <strong>Instagram:</strong> <a href="${video.link}" target="_blank">View Reel</a><br>
          <strong>YouTube:</strong> ${video.youtube_video_id ? 
            `<a href="https://youtube.com/watch?v=${video.youtube_video_id}" target="_blank">Watch Video</a>` 
            : "<span style='color: #999;'>Not uploaded yet</span>"}<br>
          <strong>Scheduled:</strong> ${scheduledTime}<br>
          <strong>Video Editing:</strong> ${editingStatus}<br>
          ${video.title ? `<strong>Title:</strong> ${video.title}<br>` : ''}
          ${video.error ? `<strong style="color:red">Error:</strong> ${video.error}<br>` : ''}
          <small style="color: #666;">Created: ${new Date(video.created_at).toLocaleString()}</small>
        </div>
      `;
    });
  } catch (err) {
    console.log("Load videos error:", err);
    document.getElementById("videos").innerHTML = "<p style='color:red;'>Error loading jobs</p>";
  }
}

// Load AI shorts queue
async function loadAIVideos() {
  try {
    const { data } = await supabaseClient
      .from("ai_shorts_queue")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(10);

    const container = document.getElementById("aiVideos");
    container.innerHTML = "";

    if (!data || data.length === 0) {
      container.innerHTML = "<p>No AI shorts in queue yet.</p>";
      return;
    }

    data.forEach(video => {
      const scheduledTime = video.scheduled_publish_at 
        ? new Date(video.scheduled_publish_at).toLocaleString() 
        : "Not scheduled";
      
      const statusColor = {
        'pending': 'orange',
        'processing': 'blue',
        'done': 'green',
        'failed': 'red'
      }[video.status] || 'gray';
      
      const sourceLabel = video.source === 'reddit_manual' ? 'üìù Reddit' : 'ü§ñ AI';

      container.innerHTML += `
        <div style="margin-bottom:15px; padding:15px; border-left: 4px solid ${statusColor}; background-color: #f9f9f9;">
          <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${video.status}</span> ${sourceLabel}<br>
          ${video.topic ? `<strong>Topic:</strong> ${video.topic}<br>` : ''}
          ${video.title ? `<strong>Title:</strong> ${video.title}<br>` : ''}
          <strong>YouTube:</strong> ${video.youtube_video_id ? 
            `<a href="https://youtube.com/watch?v=${video.youtube_video_id}" target="_blank">Watch Video</a>` 
            : "<span style='color: #999;'>Not uploaded yet</span>"}<br>
          <strong>Scheduled:</strong> ${scheduledTime}<br>
          ${video.error ? `<strong style="color:red">Error:</strong> ${video.error}<br>` : ''}
          <small style="color: #666;">Created: ${new Date(video.created_at).toLocaleString()}</small>
        </div>
      `;
    });
  } catch (err) {
    console.log("Load AI videos error:", err);
    document.getElementById("aiVideos").innerHTML = "<p style='color:red;'>Error loading jobs</p>";
  }
}

// Load B-roll list
async function loadBrolls() {
  try {
    const { data } = await supabaseClient
      .from("reddit_broll")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(20);

    const container = document.getElementById("brollList");
    container.innerHTML = "";

    if (!data || data.length === 0) {
      container.innerHTML = "<p>No B-rolls downloaded yet.</p>";
      return;
    }

    data.forEach(broll => {
      container.innerHTML += `
        <div style="margin-bottom:10px; padding:12px; background-color: #f9f9f9; border-radius: 4px;">
          <strong>${broll.filename}</strong><br>
          <small>Duration: ${broll.duration_seconds}s | Size: ${broll.file_size_mb}MB | Used: ${broll.times_used}x</small><br>
          <small style="color: #666;">${new Date(broll.created_at).toLocaleString()}</small>
        </div>
      `;
    });
  } catch (err) {
    console.log("Load B-rolls error:", err);
    document.getElementById("brollList").innerHTML = "<p style='color:red;'>Error loading B-rolls</p>";
  }
}

// Load B-rolls for dropdown
async function loadBrollsForSelect() {
  try {
    const { data } = await supabaseClient
      .from("reddit_broll")
      .select("filename, duration_seconds")
      .order("created_at", { ascending: false });

    const select = document.getElementById("brollSelect");
    select.innerHTML = '<option value="">Select a B-roll video...</option>';

    if (data && data.length > 0) {
      data.forEach(broll => {
        select.innerHTML += `<option value="${broll.filename}">${broll.filename} (${broll.duration_seconds}s)</option>`;
      });
    }
  } catch (err) {
    console.log("Load B-rolls for select error:", err);
  }
}

// Load Reddit shorts queue (shows both AI and Reddit shorts from same table)
async function loadRedditQueue() {
  try {
    const { data } = await supabaseClient
      .from("ai_shorts_queue")
      .select("*")
      .eq("source", "reddit_manual")
      .order("created_at", { ascending: false })
      .limit(10);

    const container = document.getElementById("redditVideos");
    container.innerHTML = "";

    if (!data || data.length === 0) {
      container.innerHTML = "<p>No Reddit shorts in queue yet.</p>";
      return;
    }

    data.forEach(video => {
      const scheduledTime = video.scheduled_publish_at 
        ? new Date(video.scheduled_publish_at).toLocaleString() 
        : "Not scheduled";
      
      const statusColor = {
        'pending': 'orange',
        'processing': 'blue',
        'done': 'green',
        'failed': 'red'
      }[video.status] || 'gray';

      container.innerHTML += `
        <div style="margin-bottom:15px; padding:15px; border-left: 4px solid ${statusColor}; background-color: #f9f9f9;">
          <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${video.status}</span><br>
          <strong>Title:</strong> ${video.title}<br>
          ${video.reddit_url ? `<strong>Reddit:</strong> <a href="${video.reddit_url}" target="_blank">View Post</a><br>` : ''}
          <strong>B-roll:</strong> ${video.broll_filename || 'N/A'}<br>
          <strong>Custom Card:</strong> ${video.custom_card_url ? 'Yes ‚úì' : 'No (generated)'}<br>
          <strong>YouTube:</strong> ${video.youtube_video_id ? 
            `<a href="https://youtube.com/watch?v=${video.youtube_video_id}" target="_blank">Watch Video</a>` 
            : "<span style='color: #999;'>Not uploaded yet</span>"}<br>
          <strong>Scheduled:</strong> ${scheduledTime}<br>
          ${video.error ? `<strong style="color:red">Error:</strong> ${video.error}<br>` : ''}
          <small style="color: #666;">Created: ${new Date(video.created_at).toLocaleString()}</small>
        </div>
      `;
    });
  } catch (err) {
    console.log("Load Reddit queue error:", err);
    document.getElementById("redditVideos").innerHTML = "<p style='color:red;'>Error loading jobs</p>";
  }
}

// ----------------------
// Cleanup old records button (Instagram)
// ----------------------
document.getElementById("cleanupOld").onclick = async () => {
  const statusEl = document.getElementById("cleanupStatus");
  
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const cutoffDate = thirtyDaysAgo.toISOString();
  
  try {
    const { data: toDelete, error: countError } = await supabaseClient
      .from("queue")
      .select("id", { count: 'exact', head: true })
      .eq("status", "done")
      .lt("created_at", cutoffDate);
    
    if (countError) {
      statusEl.textContent = "‚ùå Error counting records";
      statusEl.style.color = "red";
      return;
    }
    
    const count = toDelete?.length || 0;
    
    if (count === 0) {
      statusEl.textContent = "‚úì No old records to delete";
      statusEl.style.color = "green";
      return;
    }
    
    const confirmed = confirm(`Delete ${count} records older than 30 days with status "done"?`);
    if (!confirmed) {
      statusEl.textContent = "Cancelled";
      statusEl.style.color = "#666";
      return;
    }
    
    const { error: deleteError } = await supabaseClient
      .from("queue")
      .delete()
      .eq("status", "done")
      .lt("created_at", cutoffDate);
    
    if (deleteError) {
      statusEl.textContent = "‚ùå Delete failed: " + deleteError.message;
      statusEl.style.color = "red";
      console.log("Delete error:", deleteError);
    } else {
      statusEl.textContent = `‚úì Deleted ${count} old records`;
      statusEl.style.color = "green";
      loadVideos();
      
      setTimeout(() => {
        statusEl.textContent = "";
      }, 5000);
    }
    
  } catch (err) {
    statusEl.textContent = "‚ùå Error: " + err.message;
    statusEl.style.color = "red";
    console.log("Cleanup error:", err);
  }
};

// ----------------------
// Cleanup AI Shorts Queue (delete all but last 10)
// ----------------------
document.getElementById("cleanupAIQueue").onclick = async () => {
  const statusEl = document.getElementById("aiStatus");
  
  try {
    // Get all AI shorts ordered by creation date
    const { data: allJobs } = await supabaseClient
      .from("ai_shorts_queue")
      .select("id")
      .order("created_at", { ascending: false });
    
    if (!allJobs || allJobs.length <= 10) {
      statusEl.textContent = "‚úì No old records to delete (10 or fewer total)";
      statusEl.style.color = "green";
      setTimeout(() => { statusEl.textContent = ""; }, 5000);
      return;
    }
    
    // Get IDs to delete (everything after the first 10)
    const idsToDelete = allJobs.slice(10).map(job => job.id);
    
    const confirmed = confirm(`Delete ${idsToDelete.length} old records (keep last 10)?`);
    if (!confirmed) {
      statusEl.textContent = "Cancelled";
      statusEl.style.color = "#666";
      setTimeout(() => { statusEl.textContent = ""; }, 3000);
      return;
    }
    
    // Delete old records
    const { error } = await supabaseClient
      .from("ai_shorts_queue")
      .delete()
      .in("id", idsToDelete);
    
    if (error) {
      statusEl.textContent = "‚ùå Delete failed";
      statusEl.style.color = "red";
      console.error("Delete error:", error);
    } else {
      statusEl.textContent = `‚úì Deleted ${idsToDelete.length} old records`;
      statusEl.style.color = "green";
      loadAIVideos();
      setTimeout(() => { statusEl.textContent = ""; }, 5000);
    }
    
  } catch (err) {
    statusEl.textContent = "‚ùå Error: " + err.message;
    statusEl.style.color = "red";
    console.error("Cleanup error:", err);
  }
};

// ----------------------
// Cleanup Reddit Shorts Queue (delete all but last 10)
// ----------------------
document.getElementById("cleanupRedditQueue").onclick = async () => {
  const statusEl = document.getElementById("redditStatus");
  
  try {
    // Get all Reddit shorts ordered by creation date
    const { data: allJobs } = await supabaseClient
      .from("ai_shorts_queue")
      .select("id")
      .eq("source", "reddit_manual")
      .order("created_at", { ascending: false });
    
    if (!allJobs || allJobs.length <= 10) {
      statusEl.textContent = "‚úì No old records to delete (10 or fewer total)";
      statusEl.style.color = "green";
      setTimeout(() => { statusEl.textContent = ""; }, 5000);
      return;
    }
    
    // Get IDs to delete (everything after the first 10)
    const idsToDelete = allJobs.slice(10).map(job => job.id);
    
    const confirmed = confirm(`Delete ${idsToDelete.length} old records (keep last 10)?`);
    if (!confirmed) {
      statusEl.textContent = "Cancelled";
      statusEl.style.color = "#666";
      setTimeout(() => { statusEl.textContent = ""; }, 3000);
      return;
    }
    
    // Delete old records
    const { error } = await supabaseClient
      .from("ai_shorts_queue")
      .delete()
      .in("id", idsToDelete);
    
    if (error) {
      statusEl.textContent = "‚ùå Delete failed";
      statusEl.style.color = "red";
      console.error("Delete error:", error);
    } else {
      statusEl.textContent = `‚úì Deleted ${idsToDelete.length} old records`;
      statusEl.style.color = "green";
      loadRedditQueue();
      setTimeout(() => { statusEl.textContent = ""; }, 5000);
    }
    
  } catch (err) {
    statusEl.textContent = "‚ùå Error: " + err.message;
    statusEl.style.color = "red";
    console.error("Cleanup error:", err);
  }
};

// ----------------------
// Page load
// ----------------------
initAuth();

</script>
</body>
</html>
