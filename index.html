<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Instagram ‚Üí YouTube Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 800px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #login, #submit {
      background-color: #4CAF50;
      color: white;
    }
    #logout {
      background-color: #666;
      color: white;
    }
    #clearAuth {
      background-color: #dc3545;
      color: white;
    }
    .video-editor-section {
      background-color: #f0f8ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border: 2px solid #4CAF50;
    }
    .video-editor-section h4 {
      margin-top: 0;
      color: #2e7d32;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .helper-text {
      font-size: 12px;
      color: #666;
      margin-top: 3px;
    }
  </style>
</head>
<body>

<h2>Instagram ‚Üí YouTube Admin</h2>

<button id="login">Login with Google</button>
<button id="logout">Logout</button>
<button id="clearAuth">Clear Auth & Retry</button>

<div id="panel" style="display:none; margin-top: 20px;">

  <h3>Add Instagram Link</h3>
  
  <div class="form-group">
    <label for="link">Instagram URL *</label>
    <input type="text" id="link" placeholder="https://www.instagram.com/reel/..." style="width:100%; max-width:500px;">
  </div>

  <div class="form-group">
    <label for="title">Custom Title (Optional)</label>
    <input type="text" id="title" placeholder="Leave empty to use caption" style="width:100%; max-width:500px;">
  </div>

  <div class="form-group">
    <label for="description">Custom Description (Optional)</label>
    <input type="text" id="description" placeholder="Leave empty to use caption" style="width:100%; max-width:500px;">
  </div>

  <!-- NEW: Video Editing Section -->
  <div class="video-editor-section">
    <h4>‚ú® Video Editing (AI-Powered)</h4>
    
    <div class="form-group">
      <div class="checkbox-group">
        <input type="checkbox" id="enable_editing" checked>
        <label for="enable_editing" style="margin-bottom: 0;">Enable AI hooks & subtitles</label>
      </div>
      <div class="helper-text">
        Adds AI-generated hook at the start + professional subtitles throughout the video
      </div>
    </div>

    <div class="form-group">
      <label for="subtitle_position">Subtitle Position</label>
      <select id="subtitle_position" style="width: 200px;">
        <option value="bottom" selected>Bottom (Default)</option>
        <option value="center">Center</option>
        <option value="top">Top</option>
      </select>
      <div class="helper-text">
        Choose where subtitles appear on the video
      </div>
    </div>
  </div>

  <button id="submit" style="margin-top: 20px;">Submit Job</button>

  <h3>Queue Status (Last 10 Jobs)</h3>
  <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
    <button id="refreshQueue" style="background-color: #2196F3; color: white;">
      üîÑ Refresh Queue
    </button>
    <button id="cleanupOld" style="background-color: #ff9800; color: white;">
      üóëÔ∏è Cleanup Old Records (30+ days)
    </button>
    <span id="cleanupStatus" style="font-size: 12px; color: #666;"></span>
  </div>
  <div id="videos" style="margin-top:10px;"></div>

</div>

<script>
// ‚úÖ Fix: use a different variable name to avoid global conflict
const supabaseClient = window.supabase.createClient(
  "https://colyuvayzgcdifnuivnz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvbHl1dmF5emdjZGlmbnVpdm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5ODk1MDMsImV4cCI6MjA4NjU2NTUwM30.tDiCCUp5uBH7j05QP-Yy_0rwF7mqxMVPaoQViYEl2MM"
);

const ADMIN_EMAIL = "crazychannelprofessional@gmail.com";

// ----------------------
// Detect if mobile device
// ----------------------
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// ----------------------
// Handle OAuth session on page load - with error handling
// ----------------------
async function initAuth() {
  try {
    // First, let Supabase process any OAuth callback in the URL
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    
    if (error) {
      console.log("Session error:", error);
      // Clear the hash on error (don't alert - silent fail)
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname);
      }
      return;
    }
    
    // NOW we can clear the hash from URL (after Supabase processed it)
    if (window.location.hash) {
      history.replaceState(null, '', window.location.pathname);
    }
    
    // Check if user is authorized
    checkUser();
    
  } catch (error) {
    console.log("Init auth error:", error);
  }
}

// ----------------------
// Show or hide admin panel
// ----------------------
async function checkUser() {
  const { data: { user } } = await supabaseClient.auth.getUser();

  if (user && user.email === ADMIN_EMAIL) {
    document.getElementById("panel").style.display = "block";
    loadVideos();
  } else {
    document.getElementById("panel").style.display = "none";
    console.log("Unauthorized or not logged in");
  }
}

// ----------------------
// Login button
// ----------------------
document.getElementById("login").onclick = async () => {
  const isMobile = isMobileDevice();
  
  const { data, error } = await supabaseClient.auth.signInWithOAuth({
    provider: 'google',
    options: { 
      redirectTo: 'https://dadopolumentol.github.io/instagram-youtube-admin/', // Always redirect to full path
      ...(isMobile ? {} : { flowType: 'popup' })
    }
  });

  if (error) {
    console.log("Login error:", error);
    alert("Login error: " + error.message);
  } else if (!isMobile) {
    checkUser();
  }
};

// ----------------------
// Logout button - improved with full cleanup
// ----------------------
document.getElementById("logout").onclick = async () => {
  await supabaseClient.auth.signOut();
  
  // Clear all Supabase storage
  localStorage.clear();
  sessionStorage.clear();
  
  // Clear URL hash if present
  if (window.location.hash) {
    history.replaceState(null, '', window.location.pathname);
  }
  
  location.reload();
};


// ----------------------
// Clear Auth button
// ----------------------
document.getElementById("clearAuth").onclick = () => {
  // Nuclear option - clear everything
  localStorage.clear();
  sessionStorage.clear();
  
  // Clear URL
  history.replaceState(null, '', window.location.pathname + window.location.search);
  
  alert("Auth data cleared. Click Login to try again.");
  location.reload();
};

// ----------------------
// Submit Instagram link with video editing options
// ----------------------
document.getElementById("submit").onclick = async () => {
  const link = document.getElementById("link").value.trim();
  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  
  // NEW: Get video editing options
  const enable_editing = document.getElementById("enable_editing").checked;
  const subtitle_position = document.getElementById("subtitle_position").value;

  if (!link) { 
    alert("Instagram link required"); 
    return; 
  }

  try {
    await supabaseClient.from("queue").insert([{
      link: link,
      title: title || null,
      description: description || null,
      status: "pending",
      enable_editing: enable_editing,        // NEW
      subtitle_position: subtitle_position   // NEW
    }]);

    alert("Job submitted successfully!");
    
    // Clear form
    document.getElementById("link").value = "";
    document.getElementById("title").value = "";
    document.getElementById("description").value = "";
    document.getElementById("enable_editing").checked = true;  // Reset to default
    document.getElementById("subtitle_position").value = "bottom";  // Reset to default
    
    loadVideos();
  } catch (err) {
    console.log("Insert error:", err);
    alert("Failed to insert link. Check console.");
  }
};

// ----------------------
// Refresh queue button
// ----------------------
document.getElementById("refreshQueue").onclick = () => {
  loadVideos();
};

// ----------------------
// Cleanup old records button
// ----------------------
document.getElementById("cleanupOld").onclick = async () => {
  const statusEl = document.getElementById("cleanupStatus");
  
  // Calculate date 30 days ago
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const cutoffDate = thirtyDaysAgo.toISOString();
  
  try {
    // First, count how many records would be deleted
    const { data: toDelete, error: countError } = await supabaseClient
      .from("queue")
      .select("id", { count: 'exact', head: true })
      .eq("status", "done")
      .lt("created_at", cutoffDate);
    
    if (countError) {
      statusEl.textContent = "‚ùå Error counting records";
      statusEl.style.color = "red";
      return;
    }
    
    const count = toDelete?.length || 0;
    
    if (count === 0) {
      statusEl.textContent = "‚úì No old records to delete";
      statusEl.style.color = "green";
      return;
    }
    
    // Confirm deletion
    const confirmed = confirm(`Delete ${count} records older than 30 days with status "done"?`);
    if (!confirmed) {
      statusEl.textContent = "Cancelled";
      statusEl.style.color = "#666";
      return;
    }
    
    // Delete the records
    const { error: deleteError } = await supabaseClient
      .from("queue")
      .delete()
      .eq("status", "done")
      .lt("created_at", cutoffDate);
    
    if (deleteError) {
      statusEl.textContent = "‚ùå Delete failed: " + deleteError.message;
      statusEl.style.color = "red";
      console.log("Delete error:", deleteError);
    } else {
      statusEl.textContent = `‚úì Deleted ${count} old records`;
      statusEl.style.color = "green";
      loadVideos();  // Refresh the list
      
      // Clear status after 5 seconds
      setTimeout(() => {
        statusEl.textContent = "";
      }, 5000);
    }
    
  } catch (err) {
    statusEl.textContent = "‚ùå Error: " + err.message;
    statusEl.style.color = "red";
    console.log("Cleanup error:", err);
  }
};

// ----------------------
// Load last 10 jobs from queue
// ----------------------
async function loadVideos() {
  try {
    const { data } = await supabaseClient
      .from("queue")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(10);  // Changed from 20 to 10

    const container = document.getElementById("videos");
    container.innerHTML = "";

    if (!data || data.length === 0) {
      container.innerHTML = "<p>No jobs in queue yet.</p>";
      return;
    }

    data.forEach(video => {
      const scheduledTime = video.scheduled_publish_at 
        ? new Date(video.scheduled_publish_at).toLocaleString() 
        : "Not scheduled";
      
      const statusColor = {
        'pending': 'orange',
        'processing': 'blue',
        'done': 'green',
        'failed': 'red'
      }[video.status] || 'gray';

      // NEW: Show editing status
      const editingStatus = video.enable_editing 
        ? `‚úÖ Editing enabled (${video.subtitle_position || 'bottom'})` 
        : '‚è≠Ô∏è Editing disabled';

      container.innerHTML += `
        <div style="margin-bottom:15px; padding:15px; border-left: 4px solid ${statusColor}; background-color: #f9f9f9;">
          <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${video.status}</span><br>
          <strong>Instagram:</strong> <a href="${video.link}" target="_blank">View Reel</a><br>
          <strong>YouTube:</strong> ${video.youtube_video_id ? 
            `<a href="https://youtube.com/watch?v=${video.youtube_video_id}" target="_blank">Watch Video</a>` 
            : "<span style='color: #999;'>Not uploaded yet</span>"}<br>
          <strong>Scheduled:</strong> ${scheduledTime}<br>
          <strong>Video Editing:</strong> ${editingStatus}<br>
          ${video.title ? `<strong>Title:</strong> ${video.title}<br>` : ''}
          ${video.error ? `<strong style="color:red">Error:</strong> ${video.error}<br>` : ''}
          <small style="color: #666;">Created: ${new Date(video.created_at).toLocaleString()}</small>
        </div>
      `;
    });
  } catch (err) {
    console.log("Load videos error:", err);
    document.getElementById("videos").innerHTML = "<p style='color:red;'>Error loading jobs</p>";
  }
}

// ----------------------
// Page load
// ----------------------
initAuth();

</script>
</body>
</html>
